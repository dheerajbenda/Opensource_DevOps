<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Health Check Status</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        .fixed-header {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 1000;
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        .fixed-header h1 {
            margin: 0;
            font-size: 1.8em;
        }

        .filter-container {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .content {
            margin: 20px;
            padding-top: 20px;
        }

        .table {
            margin-top: 20px;
        }

        .dropdown-select {
            width: 300px;
        }

        .status-up {
            color: green;
        }

        .status-down {
            color: red;
        }

        .status-loading {
            color: orange;
        }
    </style>
</head>
<body>
<div class="fixed-header">
    <div>
        <h1>Health Check Status</h1>
        <div id="lastRefreshTime" class="text-muted">Last auto-refresh: Not yet refreshed</div>
    </div>
    <div class="filter-container">
        <select id="serviceSelect" class="dropdown-select" multiple="multiple"></select>
        <button id="refreshButton" class="btn btn-primary btn-sm">Refresh</button>
    </div>
</div>
<div class="content">
    <table class="table table-bordered">
        <thead>
        <tr>
            <th>Service Name</th>
            <th>Status</th>
        </tr>
        </thead>
        <tbody id="servicesTableBody"></tbody>
    </table>
</div>
<script>
    $(document).ready(function () {
        // Initialize Select2 dropdown
        $('#serviceSelect').select2({
            placeholder: "Select Services",
            allowClear: true,
            closeOnSelect: false
        });

        const services = ["Google", "Yahoo", "Test"];
        const tableBody = $("#servicesTableBody");

        function populateTable() {
            tableBody.empty();
            services.forEach(service => {
                const row = `<tr id="${service}">
                                <td>${service}</td>
                                <td class="status-loading">Loading...</td>
                            </tr>`;
                tableBody.append(row);
                updateServiceStatus(service);
            });
        }

        function updateDropdown() {
            const dropdown = $("#serviceSelect");
            dropdown.empty();
            services.forEach(service => {
                const option = new Option(service, service, true, true);
                dropdown.append(option);
            });
            dropdown.trigger('change');
        }

        function updateServiceStatus(serviceName) {
            fetch(`/websites/status/individual?serviceName=${serviceName}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(status => {
                    const statusCell = $(`#${serviceName}`).find("td").eq(1);
                    if (status.includes("up")) {
                        statusCell.html(`<span class="status-up">${status}</span>`);
                    } else {
                        statusCell.html(`<span class="status-down">${status}</span>`);
                    }
                })
                .catch(error => {
                    console.error(`Error fetching status for ${serviceName}:`, error);
                    const statusCell = $(`#${serviceName}`).find("td").eq(1);
                    statusCell.html('<span class="status-down">Error fetching status</span>');
                });
        }

        // Event listener for dropdown changes
        $('#serviceSelect').on('change', function () {
            const selected = $(this).val();
            tableBody.children().each(function () {
                const id = $(this).attr('id');
                if (selected.includes(id)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // Refresh button logic
        $("#refreshButton").on("click", function () {
            tableBody.children().each(function () {
                const id = $(this).attr('id');
                updateServiceStatus(id);
            });
        });

        populateTable();
        updateDropdown();
    });
</script>
</body>
</html>
